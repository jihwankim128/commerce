<!-- src/main/resources/templates/orders.html -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}"></head>
<title>ì£¼ë¬¸ ë‚´ì—­</title>
<body>
<nav th:replace="~{fragments/navbar :: navbar}"></nav>

<div class="content">
    <div class="container">
        <h2 class="mb-4">ğŸ“¦ ì£¼ë¬¸ ë‚´ì—­</h2>

        <div id="orders-list">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                </div>
                <p class="text-muted mt-2">ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function getStatusBadge(status) {
        const badges = {
            'ORDER_COMPLETED': 'secondary',
            'PAYMENT_FULL_FILL': 'success',
            'ORDER_CANCELLED': 'danger',
            'PARTIAL_CANCELED': 'warning'
        };
        return badges[status] || 'secondary';
    }

    function getStatusText(status) {
        const texts = {
            'ORDER_COMPLETED': 'ì£¼ë¬¸ì™„ë£Œ',
            'PAYMENT_FULL_FILL': 'ê²°ì œì™„ë£Œ',
            'ORDER_CANCELLED': 'ì·¨ì†Œì™„ë£Œ',
            'PARTIAL_CANCELED': 'ë¶€ë¶„ì·¨ì†Œ'
        };
        return texts[status] || status;
    }

    function calculateCanceledAmount(items) {
        return items
            .filter(item => item.status === 'CANCELED')
            .reduce((sum, item) => sum + item.amount, 0);
    }

    async function loadOrders() {
        const ordersList = document.getElementById('orders-list');

        try {
            const response = await fetch('/api/orders');
            const data = await response.json();

            if (!response.ok || data.status === 'ERROR') {
                throw new Error(data.body?.errors || 'ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }

            const orders = data.body;

            if (!orders || orders.length === 0) {
                ordersList.innerHTML = `
                    <div class="text-center py-5">
                        <svg width="64" height="64" fill="currentColor" class="text-muted mb-3" viewBox="0 0 16 16">
                            <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                        </svg>
                        <p class="text-muted">ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <a href="/products" class="btn btn-primary mt-3">ì‡¼í•‘í•˜ëŸ¬ ê°€ê¸°</a>
                    </div>
                `;
                return;
            }

            ordersList.innerHTML = orders.map(order => {
                const canceledAmount = calculateCanceledAmount(order.items);
                const remainingAmount = order.totalAmount - canceledAmount;
                const hasCanceled = canceledAmount > 0;

                return `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="mb-1">ì£¼ë¬¸ë²ˆí˜¸: ${order.orderId}</h5>
                                    <small class="text-muted">${order.ordererName} | ${order.ordererPhoneNumber}</small>
                                </div>
                                <span class="badge bg-${getStatusBadge(order.status)}">
                                    ${getStatusText(order.status)}
                                </span>
                            </div>
                            <div class="mb-3">
                                ${order.items.map(item => `
                                    <div class="d-flex justify-content-between text-sm mb-1">
                                        <span ${item.status === 'CANCELED' ? 'class="text-muted text-decoration-line-through"' : ''}>
                                            ${item.productName} Ã— ${item.quantity}
                                            ${item.status === 'CANCELED' ? '<span class="badge bg-secondary ms-1">ì·¨ì†Œ</span>' : ''}
                                        </span>
                                        <span ${item.status === 'CANCELED' ? 'class="text-muted text-decoration-line-through"' : ''}>
                                            ${item.amount.toLocaleString()}ì›
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                            <hr>
                            ${hasCanceled ? `
                                <div class="d-flex justify-content-between text-sm mb-2 text-danger">
                                    <span>ì·¨ì†Œ ê¸ˆì•¡</span>
                                    <span>-${canceledAmount.toLocaleString()}ì›</span>
                                </div>
                            ` : ''}
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">${hasCanceled ? 'ë‚¨ì€ ê¸ˆì•¡' : 'ì´ ê¸ˆì•¡'}: ${remainingAmount.toLocaleString()}ì›</h5>
                                <a href="/orders/${order.orderId}" class="btn btn-outline-primary btn-sm">ìƒì„¸ë³´ê¸°</a>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

        } catch (error) {
            console.error('ì£¼ë¬¸ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
            ordersList.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading">
                        <svg width="24" height="24" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                            <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                        </svg>
                        ì˜¤ë¥˜
                    </h4>
                    <p class="mb-0">${error.message}</p>
                    <hr>
                    <button class="btn btn-outline-danger btn-sm" onclick="loadOrders()">ë‹¤ì‹œ ì‹œë„</button>
                </div>
            `;
        }
    }

    loadOrders();
</script>
</body>
</html>