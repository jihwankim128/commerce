<!-- src/main/resources/templates/checkout.html -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}"></head>
<title>ê²°ì œ</title>
<style>
    .w-100 {
        width: 100%;
    }

    .box_section {
        padding: 40px 30px 50px 30px;
        margin-top: 30px;
        margin-bottom: 50px;
        background: white;
        border-radius: 8px;
    }
</style>
<body>
<nav th:replace="~{fragments/navbar :: navbar}"></nav>

<div class="content">
    <div class="container">
        <h2 class="mb-4">ğŸ’³ ê²°ì œ</h2>

        <!-- ì£¼ë¬¸ ì •ë³´ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">ì£¼ë¬¸ ì •ë³´</h5>
            </div>
            <div class="card-body" id="order-info">
                <!-- ì£¼ë¬¸ ì •ë³´ -->
            </div>
        </div>

        <!-- í† ìŠ¤ ê²°ì œ ìœ„ì ¯ -->
        <div class="wrapper">
            <div class="box_section">
                <!-- ê²°ì œ UI -->
                <div id="payment-method"></div>
                <!-- ì´ìš©ì•½ê´€ UI -->
                <div id="agreement"></div>
                <!-- ê²°ì œí•˜ê¸° ë²„íŠ¼ -->
                <div class="result wrapper">
                    <button class="btn btn-primary w-100" id="payment-button" style="margin-top: 30px">
                        ê²°ì œí•˜ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://js.tosspayments.com/v2/standard"></script>
<script>
    window.addEventListener('load', function () {
        const orderData = JSON.parse(sessionStorage.getItem('orderData'));
        console.log(orderData);

        if (!orderData) {
            alert('ì£¼ë¬¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
            window.location.href = '/products';
            return;
        }

        // ì£¼ë¬¸ ì •ë³´ í‘œì‹œ
        document.getElementById('order-info').innerHTML = `
                <p><strong>ì£¼ë¬¸ë²ˆí˜¸:</strong> ${orderData.orderId}</p>
                <p><strong>ì£¼ë¬¸ì:</strong> ${orderData.ordererName}</p>
                <p><strong>ì „í™”ë²ˆí˜¸:</strong> ${orderData.ordererPhoneNumber}</p>
                <hr>
                <h6 class="mb-3">ì£¼ë¬¸ ìƒí’ˆ</h6>
                ${orderData.items.map(item => `
                    <div class="d-flex justify-content-between mb-2">
                        <span>${item.productName} Ã— ${item.quantity}</span>
                        <span>${(item.price * item.quantity).toLocaleString()}ì›</span>
                    </div>
                `).join('')}
                <hr>
                <div class="d-flex justify-content-between">
                    <h5 class="mb-0">ì´ ê²°ì œ ê¸ˆì•¡</h5>
                    <h5 class="mb-0 text-primary">${orderData.totalAmount.toLocaleString()}ì›</h5>
                </div>
            `;

        if (typeof TossPayments === 'undefined') {
            console.error('TossPayments SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            alert('ê²°ì œ ì‹œìŠ¤í…œì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
            return;
        }

        main(orderData);
    });

    async function main(orderData) {
        const button = document.getElementById("payment-button");

        try {
            const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
            const tossPayments = TossPayments(clientKey);

            const widgets = tossPayments.widgets({
                customerKey: TossPayments.ANONYMOUS,
            });

            // âœ… ì§ì ‘ ìˆ«ì ë³€í™˜
            console.log(orderData)
            await widgets.setAmount({
                currency: "KRW",
                value: Number(orderData.totalAmount),
            });

            await Promise.all([
                widgets.renderPaymentMethods({
                    selector: "#payment-method",
                    variantKey: "DEFAULT",
                }),
                widgets.renderAgreement({
                    selector: "#agreement",
                    variantKey: "AGREEMENT"
                }),
            ]);

            button.addEventListener("click", async function () {
                try {
                    await widgets.requestPayment({
                        orderId: orderData.orderId,
                        orderName: `${orderData.items[0].productName} ì™¸ ${orderData.items.length - 1}ê±´`,
                        successUrl: window.location.origin + "/success",
                        failUrl: window.location.origin + "/fail",
                        customerEmail: "customer@example.com",
                        customerName: orderData.ordererName,
                        customerMobilePhone: orderData.ordererPhoneNumber,
                    });
                } catch (error) {
                    console.error('ê²°ì œ ìš”ì²­ ì‹¤íŒ¨:', error.message);
                    alert('ê²°ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            });
        } catch (error) {
            console.error('ê²°ì œ ìœ„ì ¯ ì´ˆê¸°í™” ì‹¤íŒ¨:', error.message);
            alert('ê²°ì œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }
</script>
</body>
</html>