<!-- src/main/resources/templates/order-detail.html -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}"></head>
<title>Ï£ºÎ¨∏ ÏÉÅÏÑ∏</title>
<body>
<nav th:replace="~{fragments/navbar :: navbar}"></nav>

<div class="content">
    <div class="container">
        <div class="mb-3">
            <a class="btn btn-outline-secondary btn-sm" href="/orders">‚Üê Ï£ºÎ¨∏ ÎÇ¥Ïó≠</a>
        </div>

        <h2 class="mb-4">üìã Ï£ºÎ¨∏ ÏÉÅÏÑ∏</h2>

        <div id="order-detail">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Î°úÎî©...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const orderId = window.location.pathname.split('/').pop();

    async function loadOrderDetail() {
        try {
            const response = await fetch(`/api/orders/${orderId}`);
            const data = await response.json();
            if (!response.ok || data.status === "ERROR") {
                throw new Error(data.body?.errors);
            }

            const order = data.body;

            document.getElementById('order-detail').innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5 class="mb-0">Ï£ºÎ¨∏ Ï†ïÎ≥¥</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Ï£ºÎ¨∏Î≤àÌò∏:</strong> ${order.orderId}</p>
                                    <p><strong>Ï£ºÎ¨∏Ïûê:</strong> ${order.ordererName}</p>
                                    <p><strong>Ï†ÑÌôîÎ≤àÌò∏:</strong> ${order.ordererPhoneNumber}</p>
                                    <p><strong>Ï£ºÎ¨∏ ÏÉÅÌÉú:</strong>
                                        <span class="badge bg-${order.status === 'PAYMENT_FULLFILL' ? 'success' : 'secondary'}">
                                            ${order.status === 'PAYMENT_FULLFILL' ? 'Í≤∞Ï†úÏôÑÎ£å' : order.status}
                                        </span>
                                    </p>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Ï£ºÎ¨∏ ÏÉÅÌíà</h5>
                                </div>
                                <div class="card-body">
                                    ${order.items.map(item => `
                                        <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                                            <div>
                                                <h6 class="mb-1">${item.productName}</h6>
                                                <small class="text-muted">${item.price.toLocaleString()}Ïõê √ó ${item.quantity}Í∞ú</small>
                                            </div>
                                            <strong>${item.amount.toLocaleString()}Ïõê</strong>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">Í≤∞Ï†ú Ï†ïÎ≥¥</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>ÏÉÅÌíà Í∏àÏï°</span>
                                        <span>${order.totalAmount.toLocaleString()}Ïõê</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <h5 class="mb-0">Ï¥ù Í≤∞Ï†ú Í∏àÏï°</h5>
                                        <h5 class="mb-0 text-primary">${order.totalAmount.toLocaleString()}Ïõê</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const existingIndex = orders.findIndex(o => o.orderId === order.orderId);
            if (existingIndex >= 0) {
                orders[existingIndex] = order;
            } else {
                orders.unshift(order);
            }
            localStorage.setItem('orders', JSON.stringify(orders));
        } catch (error) {
            document.getElementById('order-detail').innerHTML = `
                    <div class="alert alert-danger text-center" role="alert">
                        <h4 class="alert-heading">Ïò§Î•ò</h4>
                        <p>${error.message}</p>
                        <hr>
                        <a href="/orders" class="btn btn-primary">Ï£ºÎ¨∏ ÎÇ¥Ïó≠ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</a>
                    </div>
                `;
        }
    }

    loadOrderDetail();
</script>
</body>
</html>